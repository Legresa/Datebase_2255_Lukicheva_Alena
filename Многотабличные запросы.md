Многотабличные запросы
#1
SELECT st.name, st.surname, hb.name
FROM student st, hobby hb, student_hobby sh
WHERE sh.student_id = st.id AND sh.hobby_id = hb.id
#2
SELECT st.name, st.surname, sh.data_start
FROM student st, student_hobby sh
WHERE st.id = sh.student_id AND sh.data_end IS NULL
ORDER BY sh.data_start
LIMIT 1
#3
SELECT DISTINCT st.score, st.name, st.surname, st.dateburth
FROM student st
INNER JOIN
(
SELECT SUM(hb.risk) as r_summ, sh.student_id
FROM hobby hb,
student_hobby sh
WHERE hb.id= sh.hobby_id AND sh.data_end IS NULL
GROUP BY sh.student_id
)t
ON st.id = t.student_id
AND t.r_summ > 9
WHERE st.score >
(
SELECT AVG(score)::numeric(3,2)
FROM student
)
#4
SELECT st.name, st.surname, st.n_group, st.dateburth, tt.monthes, tt.name
FROM student st
INNER JOIN
(SELECT (to_char(sh.data_end, 'MM')::numeric(10,0) + to_char(sh.data_end, 'YYYY')::numeric(10,0) * 12) - (to_char(sh.data_start, 'MM')::numeric(10,0) + to_char(sh.data_start, 'YYYY')::numeric(10,0) * 12) as monthes, sh.student_id, hb.name
FROM student_hobby sh, hobby hb
WHERE hb.id = sh.id) tt
ON tt.student_id = st.id
#5
SELECT st.name, st.surname, st.n_group, st.dateburth
FROM student st
INNER JOIN
(SELECT count(sh.hobby_id), sh.student_id
FROM student_hobby sh, hobby hb
WHERE hb.id = sh.hobby_id
GROUP BY sh.student_id
HAVING count(sh.hobby_id) >1) tt
ON tt.student_id = st.id
WHERE 3 = ((to_char('2024-03-19'::date, 'YYYY')::int * 12 * 30 + to_char('2024-03-19'::date, 'MM')::int * 30 + to_char('2024-03-19'::date, 'DD')::int) - (to_char(st.dateburth, 'YYYY')::int * 12 * 30 + to_char(st.dateburth, 'MM')::int * 30 + to_char(st.dateburth, 'DD')::int))/ 30 / 12
#6
SELECT DISTINCT st.n_group, avg(st.score)::numeric(3,2)
FROM student st
INNER JOIN(SELECT DISTINCT sh.student_id
FROM student_hobby sh, hobby hb
WHERE sh.hobby_id = hb.id AND sh.data_end IS NULL) tt
ON tt.student_id = st.id
GROUP BY st.n_group
#7
SELECT hb.name, hb.risk, -1 * (to_char(tt.dlit, 'YYYY')::numeric(5,0) * 12 + to_char(tt.dlit, 'MM')::numeric(5,0)) + (to_char(now(), 'YYYY')::numeric(5,0) * 12 + to_char(now(),'MM')::numeric(5,0))
FROM hobby hb
INNER JOIN(
SELECT sh.hobby_id, min(sh.data_start) as dlit, sh.student_id
FROM student_hobby sh
GROUP BY sh.student_id, sh.hobby_id
HAVING sh.student_id = 3
LIMIT 1) tt
ON tt.hobby_id = hb.id
#8
SELECT hb.name
FROM student st
INNER JOIN student_hobby sh on sh.student_id = st.id
INNER JOIN hobby hb on hb.id = sh.hobby_id
WHERE st.score = (SELECT max(st.score)
FROM student st)
#9
SELECT hb.name
FROM hobby hb
INNER JOIN student_hobby sh on sh.hobby_id = hb.id AND sh.data_end IS NULL
INNER JOIN student st on st.id = sh.dfstudent_id
WHERE SUBSTRING(st.n_group::varchar, 1,1) = '2' AND st.score >= 3 AND st.score < 4
#10
SELECT SUBSTRING(st.n_group::varchar,1,1) as course
FROM student st
INNER JOIN(SELECT SUBSTRING(st.n_group::varchar,1,1) as course, count(st.id) as countofstd
FROM student st
INNER JOIN(SELECT sh.student_id, count(sh.hobby_id)
FROM student_hobby sh
WHERE sh.data_end IS NULL
GROUP BY sh.student_id
HAVING count(sh.student_id) > 1) tt
ON tt.student_id = st.id
GROUP BY SUBSTRING(st.n_group::varchar,1,1)) ttend
ON SUBSTRING(st.n_group::varchar,1,1) = ttend.course
INNER JOIN(SELECT SUBSTRING(st.n_group::varchar,1,1) as course, count(st.id) as countofstd
FROM student st
GROUP BY SUBSTRING(st.n_group::varchar,1,1)) ttnext
ON SUBSTRING(st.n_group::varchar,1,1) = ttnext.course
WHERE ttnext.countofstd / 2 + ttnext.countofstd % 2 <= ttend.countofstd
GROUP BY SUBSTRING(st.n_group::varchar,1,1)
#11
SELECT DISTINCT st.n_group
FROM student st
INNER JOIN(SELECT st.n_group, count(st.id) as countofstd, sum(st.score)
FROM student st
WHERE st.score >= 4
GROUP BY st.n_group) tt
ON st.n_group = tt.n_group
INNER JOIN(SELECT st.n_group, count(st.id) as countofstd
FROM student st
GROUP BY st.n_group) ttt
ON st.n_group = ttt.n_group
WHERE ttt.countofstd / 100 * 60 <= ttt.countofstd
#12
SELECT 
count(sh.student_id), SUBSTRING(st.n_group::varchar, 1,1)
FROM student_hobby sh, student st
WHERE sh.data_end IS NULL AND sh.student_id = st.id
GROUP BY SUBSTRING(st.n_group::varchar,1,1)
#13
SELECT st.id, st.name, st.surname, st.dateburth, SUBSTRING(st.n_group::varchar,1,1) as course
FROM student st
WHERE st.score = 5
EXCEPT SELECT DISTINCT stb.id, stb.name, stb.surname, stb.dateburth, SUBSTRING(stb.n_group::varchar,1,1) as course
FROM student_hobby sh, student stb
WHERE stb.id = sh.student_id AND sh.data_end IS NULL
ORDER BY course, dateburth
#14
CREATE OR REPLACE VIEW Student_5yearhobby AS
SELECT st.*
FROM student st, student_hobby sh
WHERE st.id = sh.student_id AND sh.data_end IS NULL AND (to_char('2025-05-10'::date, 'YYYY')::int * 12 * 30 + to_char('2025-05-10'::date, 'MM')::int * 30 + to_char('2025-05-10'::date, 'DD')::int - to_char(sh.data_start, 'YYYY')::int * 12 * 30 + to_char(sh.data_start, 'MM')::int * 30 + to_char(sh.data_start, 'DD')::int) / 30 / 12 >= 5
#15
SELECT hb.name, tt.countofhob
FROM hobby hb
INNER JOIN
(SELECT count(sh.student_id) as countofhob, sh.hobby_id
FROM student_hobby sh
WHERE sh.data_end IS NULL
GROUP BY sh.hobby_id) tt
ON tt.hobby_id = hb.id
#16
SELECT hb.name
FROM hobby hb
INNER JOIN
(SELECT count(sh.student_id) as countofhob, sh.hobby_id
FROM student_hobby sh
GROUP BY sh.hobby_id) tt
ON tt.hobby_id = hb.id
ORDER BY tt.countofhob DESC
LIMIT 1
#17
SELECT DISTINCT st.*
FROM student st, student_hobby sh
INNER JOIN
(
SELECT hb.name, hb.id
FROM hobby hb
INNER JOIN
(SELECT count(sh.student_id) as countofhob, sh.hobby_id
FROM student_hobby sh
GROUP BY sh.hobby_id) tt
ON tt.hobby_id = hb.id
ORDER BY tt.countofhob DESC
LIMIT 1
) tt
ON sh.hobby_id = tt.id
WHERE sh.student_id = st.id
#18
SELECT DISTINCT hb.id
FROM hobby hb
WHERE hb.risk = (SELECT max(risk)
FROM hobby)
LIMIT 3
#19
SELECT st.name,st.surname
FROM student st
INNER JOIN
(SELECT DISTINCT sh.student_id, extract(day from (justify_days(now() - sh.data_start))) as countofdays
FROM student_hobby sh
WHERE sh.data_end IS NULL
ORDER BY countofdays DESC) tt
ON tt.student_id = st.id
ORDER BY countofdays DESC LIMIT 10
#20
SELECT DISTINCT st.n_group
FROM student st
INNER JOIN(
SELECT st.name,st.surname, st.id
FROM student st
INNER JOIN
(SELECT DISTINCT sh.student_id, extract(day from (justify_days(now() - sh.data_start))) as countofdays
FROM student_hobby sh
WHERE sh.data_end IS NULL
ORDER BY countofdays DESC) tt
ON tt.student_id = st.id
ORDER BY countofdays DESC LIMIT 10
) tt
ON tt.id = st.id
#21
CREATE OR REPLACE VIEW ST_score_down AS
SELECT st.id, st.name, st.surname
FROM student st
ORDER BY st.score DESC
#22
CREATE OR REPLACE VIEW PopHb6 AS
SELECT hb.name as hobbyname, count(sh.student_id) as countofstd, SUBSTRING(st.n_group::varchar,1,1) as course
FROM hobby hb, student_hobby sh, student st
WHERE sh.hobby_id = hb.id and sh.student_id = st.id
GROUP BY hb.name, SUBSTRING(st.n_group::varchar,1,1)
ORDER BY SUBSTRING(st.n_group::varchar,1,1)

SELECT max(countofstd) as maxstd, course
FROM PopHb6
GROUP BY course

CREATE OR REPLACE VIEW TopHb AS
SELECT DISTINCT ph.course, ph.hobbyname
FROM PopHb6 ph
INNER JOIN(SELECT max(countofstd) as maxstd, course
FROM PopHb6
GROUP BY course) tt
ON tt.maxstd = ph.countofstd and tt.course = ph.course
